{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///Users/enderkalem/si_app%20copy/app/api/stripe-webhook/route.js"],"sourcesContent":["// app/api/stripe-webhook/route.js\nimport { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\n// Read raw body for signature verification\nasync function getRawBody(request) {\n  const chunks = [];\n  const reader = request.body.getReader();\n  \n  while (true) {\n    const { done, value } = await reader.read();\n    if (done) break;\n    chunks.push(value);\n  }\n  \n  const buffer = Buffer.concat(chunks.map(chunk => Buffer.from(chunk)));\n  return buffer.toString('utf8');\n}\n\nexport async function POST(request) {\n  try {\n    // Dynamic import of Stripe\n    const Stripe = (await import('stripe')).default;\n    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n      apiVersion: '2023-10-16',\n    });\n\n    const supabase = createClient(\n      process.env.SUPABASE_URL,\n      process.env.SUPABASE_SERVICE_ROLE_KEY\n    );\n\n    const body = await request.text();\n    const signature = request.headers.get('stripe-signature');\n\n    if (!signature) {\n      console.error('No signature found');\n      return NextResponse.json({ error: 'No signature' }, { status: 400 });\n    }\n\n    let event;\n\n    try {\n      event = stripe.webhooks.constructEvent(\n        body,\n        signature,\n        process.env.STRIPE_WEBHOOK_SECRET\n      );\n    } catch (err) {\n      console.error('Webhook signature verification failed:', err.message);\n      return NextResponse.json(\n        { error: 'Webhook signature verification failed' },\n        { status: 400 }\n      );\n    }\n\n    console.log('Webhook event received:', event.type);\n\n    switch (event.type) {\n      case 'checkout.session.completed': {\n        const session = event.data.object;\n        const userId = session.metadata?.userId || session.metadata?.supabase_user_id;\n        \n        console.log('Checkout completed for user:', userId);\n\n        if (userId) {\n          const { error } = await supabase.auth.admin.updateUserById(userId, {\n            user_metadata: {\n              is_premium: true,\n              stripe_customer_id: session.customer,\n              subscription_id: session.subscription,\n            },\n          });\n\n          if (error) {\n            console.error('Error updating user metadata:', error);\n          } else {\n            console.log('✅ User upgraded to premium:', userId);\n          }\n        }\n        break;\n      }\n\n      case 'customer.subscription.updated': {\n        const subscription = event.data.object;\n        const userId = subscription.metadata?.userId || subscription.metadata?.supabase_user_id;\n        \n        console.log('Subscription updated for user:', userId);\n\n        if (userId) {\n          const isPremium = subscription.status === 'active' || subscription.status === 'trialing';\n          \n          const { error } = await supabase.auth.admin.updateUserById(userId, {\n            user_metadata: {\n              is_premium: isPremium,\n              subscription_status: subscription.status,\n            },\n          });\n\n          if (error) {\n            console.error('Error updating subscription status:', error);\n          } else {\n            console.log('✅ Subscription status updated:', userId, subscription.status);\n          }\n        }\n        break;\n      }\n\n      case 'customer.subscription.deleted': {\n        const subscription = event.data.object;\n        const userId = subscription.metadata?.userId || subscription.metadata?.supabase_user_id;\n        \n        console.log('Subscription cancelled for user:', userId);\n\n        if (userId) {\n          const { error } = await supabase.auth.admin.updateUserById(userId, {\n            user_metadata: {\n              is_premium: false,\n              subscription_status: 'cancelled',\n            },\n          });\n\n          if (error) {\n            console.error('Error cancelling premium status:', error);\n          } else {\n            console.log('✅ Premium status revoked:', userId);\n          }\n        }\n        break;\n      }\n\n      default:\n        console.log('Unhandled event type:', event.type);\n    }\n\n    return NextResponse.json({ received: true });\n  } catch (err) {\n    console.error('Error processing webhook:', err);\n    return NextResponse.json(\n      { error: 'Webhook processing failed' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}